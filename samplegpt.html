<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELPER GPT - AI Study Assistant | HELPER SRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js"></script>
    <style>
        /* CSS Variables */
        :root {
            --white: #ffffff;
            --black: #1a1a1a;
            --dark-gray: #4a4a4a;
            --light-gray: #f1f3f5;
            --medium-gray: #e9ecef;
            --accent-blue: #007bff;
            --primary-gradient: linear-gradient(90deg, #007bff 0%, #00c4b4 100%);
            --success-gradient: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 8px 24px rgba(0, 0, 0, 0.2);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.25rem;
            --font-size-xl: 1.5rem;
            --font-size-2xl: 1.875rem;
            --font-size-3xl: 2.25rem;
            --font-family: 'Inter', sans-serif;
        }

        /* General Styles */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Navigation */
        .navbar {
            background: var(--white);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--black);
            text-decoration: none;
        }

        .nav-brand i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: var(--font-size-2xl);
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--dark-gray);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: var(--light-gray);
            color: var(--accent-blue);
        }

        .nav-link.active {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .hamburger {
            display: none;
            font-size: var(--font-size-lg);
            cursor: pointer;
            color: var(--dark-gray);
            padding: var(--space-sm);
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            padding: var(--space-lg) var(--space-md);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .chat-wrapper {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            gap: var(--space-lg);
        }

        .sidebar {
            width: 250px;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .sidebar-header {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--black);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--medium-gray);
        }

        .file-upload-area {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area.dragover {
            border-color: var(--accent-blue);
            background: var(--light-gray);
        }

        .file-upload-area i {
            font-size: var(--font-size-xl);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-sm);
        }

        .file-upload-area p {
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-bottom: var(--space-xs);
        }

        .file-upload-area span {
            font-size: 0.75rem;
            color: var(--dark-gray);
        }

        .uploaded-files-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .uploaded-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            background: var(--light-gray);
            margin-bottom: var(--space-sm);
            transition: all 0.3s ease;
        }

        .uploaded-file-item:hover {
            background: var(--medium-gray);
        }

        .uploaded-file-name {
            flex-grow: 1;
            font-size: var(--font-size-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-file-btn {
            background: transparent;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: var(--font-size-sm);
            padding: var(--space-xs);
            transition: all 0.3s ease;
        }

        .remove-file-btn:hover {
            color: #dc3545;
        }

        .chat-container {
            flex-grow: 1;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        .chat-header {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--medium-gray);
            text-align: center;
        }

        .chat-header h1 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--black);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .chat-header h1 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header p {
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            margin: var(--space-xs) 0 0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            max-width: 85%;
        }

        .message.user-message {
            margin-left: auto;
            flex-direction: row-reverse;
            text-align: right;
        }

        .message.bot-message {
            margin-right: auto;
        }

        .message-avatar {
            background: var(--primary-gradient);
            color: var(--white);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-base);
            flex-shrink: 0;
        }

        .message.user-message .message-avatar {
            background: var(--success-gradient);
        }

        .message-content {
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            font-size: var(--font-size-base);
            line-height: 1.5;
            box-shadow: var(--shadow-md);
        }

        .message.user-message .message-content {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--dark-gray);
            margin-top: var(--space-xs);
        }

        .message.user-message .message-time {
            color: var(--light-gray);
        }

        .thinking-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .thinking-spinner {
            display: flex;
            gap: 8px;
        }

        .thinking-dot {
            width: 12px;
            height: 12px;
            background: var(--primary-gradient);
            border-radius: 50%;
            animation: thinking 1.2s ease-in-out infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 100% {
                transform: scale(0.5);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .chat-input-container {
            border-top: 1px solid var(--medium-gray);
            padding: var(--space-md) var(--space-lg);
            background: var(--white);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-sm);
            box-shadow: var(--shadow-md);
        }

        .chat-input-wrapper textarea {
            flex-grow: 1;
            resize: none;
            border: none;
            padding: var(--space-sm);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            background: transparent;
            min-height: 40px;
            max-height: 100px;
            line-height: 1.5;
        }

        .chat-input-wrapper textarea:focus {
            outline: none;
        }

        .attachment-btn, .send-btn {
            background: var(--success-gradient);
            border: none;
            color: var(--white);
            border-radius: var(--radius-md);
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            transition: all 0.3s ease;
        }

        .attachment-btn:hover, .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .attachment-btn:active, .send-btn:active {
            transform: translateY(0);
        }

        .attachment-btn:disabled, .send-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            transform: none;
        }

        .input-suggestions {
            margin-top: var(--space-md);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
        }

        .suggestion-btn {
            background: var(--light-gray);
            border: 1px solid var(--medium-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            color: var(--dark-gray);
            transition: all 0.3s ease;
        }

        .suggestion-btn:hover {
            background: var(--medium-gray);
            color: var(--black);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                height: auto;
                padding: var(--space-sm) var(--space-lg);
            }

            .nav-brand {
                margin-bottom: var(--space-sm);
            }

            .nav-menu {
                display: none;
                flex-direction: column;
                width: 100%;
                background: var(--white);
                box-shadow: var(--shadow-md);
                padding: var(--space-md);
                position: absolute;
                top: 80px;
                left: 0;
                z-index: 999;
            }

            .nav-menu.active {
                display: flex;
            }

            .nav-link {
                width: 100%;
                justify-content: center;
                padding: var(--space-md);
                font-size: var(--font-size-base);
            }

            .nav-link span {
                display: none;
            }

            .nav-link i {
                font-size: var(--font-size-base);
            }

            .hamburger {
                display: block;
            }

            .chat-wrapper {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
            }

            .uploaded-files-list {
                max-height: 100px;
            }

            .chat-container {
                height: calc(100vh - 200px);
            }

            .chat-header h1 {
                font-size: var(--font-size-lg);
            }

            .chat-header p {
                font-size: 0.75rem;
            }

            .chat-messages {
                padding: var(--space-md);
            }

            .message {
                max-width: 90%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: var(--font-size-sm);
            }

            .message-content {
                padding: var(--space-sm);
                font-size: var(--font-size-sm);
            }

            .message-time {
                font-size: 0.7rem;
            }

            .chat-input-wrapper {
                padding: var(--space-xs);
            }

            .chat-input-wrapper textarea {
                font-size: var(--font-size-sm);
            }

            .attachment-btn, .send-btn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .input-suggestions {
                gap: var(--space-xs);
            }

            .suggestion-btn {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.75rem;
            }

            .thinking-dot {
                width: 10px;
                height: 10px;
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: var(--space-xs) var(--space-md);
            }

            .nav-brand {
                font-size: var(--font-size-lg);
            }

            .nav-brand i {
                font-size: var(--font-size-xl);
            }

            .nav-link {
                padding: var(--space-sm);
            }

            .chat-container {
                height: calc(100vh - 180px);
            }

            .chat-header h1 {
                font-size: var(--font-size-base);
            }

            .chat-messages {
                padding: var(--space-sm);
            }

            .message {
                max-width: 95%;
            }

            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }

            .message-content {
                padding: var(--space-xs) var(--space-sm);
            }

            .file-upload-area {
                padding: var(--space-sm);
            }

            .file-upload-area i {
                font-size: var(--font-size-lg);
            }

            .file-upload-area p {
                font-size: 0.75rem;
            }

            .file-upload-area span {
                font-size: 0.7rem;
            }

            .chat-input-wrapper textarea {
                min-height: 35px;
            }

            .attachment-btn, .send-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .thinking-dot {
                width: 8px;
                height: 8px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>HELPER SRM</span>
            </div>
            <i class="fas fa-bars hamburger" id="hamburger"></i>
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link" aria-label="Dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="semesters.html" class="nav-link" aria-label="Materials">
                    <i class="fas fa-book"></i>
                    <span>Materials</span>
                </a>
                <a href="gpa-simple.html" class="nav-link" aria-label="GPA Calculator">
                    <i class="fas fa-calculator"></i>
                    <span>GPA</span>
                </a>
                <a href="attendance-calculator.html" class="nav-link" aria-label="Attendance Tracker">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance Tracker</span>
                </a>
                <a href="pomodoro-timer.html" class="nav-link" aria-label="Pomodoro Timer">
                    <i class="fas fa-clock"></i>
                    <span>Timer</span>
                </a>
                <a href="ai-assistant.html" class="nav-link active" aria-label="HELPER GPT">
                    <i class="fas fa-robot"></i>
                    <span>HELPER GPT</span>
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content" role="main" aria-label="HELPER GPT">
        <div class="chat-wrapper">
            <div class="sidebar" aria-label="Study Materials">
                <div class="sidebar-header">Uploaded Study Materials</div>
                <div class="file-upload-area" id="fileUploadArea" tabindex="0" role="button" aria-label="Upload study materials">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                        <p>Upload Study Materials</p>
                        <span>PDF, DOC, DOCX, TXT, PNG, JPG, JPEG</span>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;" aria-hidden="true">
                </div>
                <div class="uploaded-files-list" id="uploadedFilesList" aria-label="Uploaded study materials list" tabindex="0"></div>
            </div>
            <section class="chat-container" aria-live="polite" aria-atomic="false" aria-relevant="additions">
                <div class="chat-header">
                    <h1><i class="fas fa-robot"></i> HELPER GPT - AI Study Assistant</h1>
                    <p>Powered by Meta Llama 3.2 11B Vision Instruct. Ask questions about your study materials!</p>
                </div>
                <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                    <div class="message bot-message" role="article" aria-label="Assistant message">
                        <div class="message-avatar" aria-hidden="true">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Hello! I'm HELPER GPT, your personal tutor. I can assist with math and science problems, explain complex concepts, summarize topics, help with homework and projects, and write code. Upload study materials or ask a question to get started.
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <button class="attachment-btn" aria-label="Attach files" title="Attach files" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <textarea
                            id="chatInput"
                            placeholder="Ask HELPER GPT about your study materials..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            aria-label="Chat input"
                            autocomplete="off"
                            spellcheck="true"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" aria-label="Send message" title="Send message" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-suggestions" role="list" aria-label="Suggested questions">
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Explain this concept from my notes')">
                            Explain concept
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Help me solve this problem')">
                            Solve problem
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Summarize my uploaded document')">
                            Summarize document
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Write code for this task')">
                            Write code
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // OpenRouter API Configuration
        const OPENROUTER_API_KEY = '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';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const EMBEDDING_URL = 'https://openrouter.ai/api/v1/embeddings';
        const MODEL = 'meta-llama/llama-3.2-11b-vision-instruct:free';
        const EMBEDDING_MODEL = 'nomic-embed-text';

        // Navigation toggle
        document.getElementById('hamburger').addEventListener('click', () => {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navMenu').classList.remove('active');
            });
        });

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const chatMessages = document.getElementById('chatMessages');
        const sendBtn = document.getElementById('sendBtn');
        let documents = []; // Store extracted text, embeddings, and base64 images

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        async function handleFiles(files) {
            for (let file of files) {
                if (file.type.match(/^(application\/(pdf|msword|vnd\.openxmlformats-officedocument\.wordprocessingml\.document)|text\/plain|image\/(png|jpeg))$/)) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'uploaded-file-item';
                    fileItem.innerHTML = `
                        <span class="uploaded-file-name">${file.name}</span>
                        <button class="remove-file-btn" aria-label="Remove ${file.name}" title="Remove file">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    uploadedFilesList.appendChild(fileItem);
                    fileItem.querySelector('.remove-file-btn').addEventListener('click', () => {
                        fileItem.remove();
                        documents = documents.filter(doc => doc.name !== file.name);
                    });

                    // Process file
                    const content = await processFile(file);
                    if (content) {
                        let base64Data = null;
                        if (file.type.startsWith('image/')) {
                            base64Data = await getImageBase64(file);
                        }
                        const chunks = chunkText(content, 500);
                        for (let i = 0; i < chunks.length; i++) {
                            const embedding = await getEmbedding(chunks[i]);
                            documents.push({ name: `${file.name}_chunk_${i}`, content: chunks[i], embedding, base64: base64Data });
                        }
                    }
                } else {
                    alert('Unsupported file type: ' + file.name);
                }
            }
            fileInput.value = '';
        }

        function chunkText(text, maxLength) {
            const chunks = [];
            for (let i = 0; i < text.length; i += maxLength) {
                chunks.push(text.slice(i, i + maxLength));
            }
            return chunks;
        }

        async function getImageBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processFile(file) {
            try {
                if (file.type.startsWith('image/')) {
                    const base64Data = await getImageBase64(file);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': 'https://helper-srm.com',
                            'X-Title': 'HELPER GPT'
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are HELPER GPT, a personal tutor and assistance provider. Analyze the provided image and describe its content in detail to assist with student queries. Provide clear, concise, and accurate descriptions without emojis or unnecessary symbols.'
                                },
                                {
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: 'Describe the content of this image in detail.' },
                                        { type: 'image_url', image_url: { url: `data:${file.type};base64,${base64Data}` } }
                                    ]
                                }
                            ]
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        console.error('Image processing error:', result.error);
                        return 'Image processing failed';
                    }
                    return result.choices?.[0]?.message?.content || 'Image processing failed';
                } else if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + ' ';
                    }
                    return text || 'PDF content extraction failed';
                } else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    return result.value || 'Document content extraction failed';
                } else if (file.type === 'text/plain') {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => resolve('Text file reading failed');
                        reader.readAsText(file);
                    });
                }
            } catch (error) {
                console.error('File processing error:', error);
                return null;
            }
            return null;
        }

        async function getEmbedding(text) {
            try {
                const response = await fetch(EMBEDDING_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://helper-srm.com',
                        'X-Title': 'HELPER GPT'
                    },
                    body: JSON.stringify({
                        model: EMBEDDING_MODEL,
                        input: text
                    })
                });
                const result = await response.json();
                if (result.error) {
                    console.error('Embedding error:', result.error);
                    return [];
                }
                return result.data?.[0]?.embedding || [];
            } catch (error) {
                console.error('Embedding error:', error);
                return [];
            }
        }

        function cosineSimilarity(vecA, vecB) {
            if (!vecA.length || !vecB.length) return 0;
            const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
            const normA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const normB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            return normA * normB ? dotProduct / (normA * normB) : 0;
        }

        async function retrieveDocuments(query) {
            const queryEmbedding = await getEmbedding(query);
            return documents
                .map(doc => ({ ...doc, score: cosineSimilarity(queryEmbedding, doc.embedding) }))
                .filter(doc => doc.score > 0.5)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="message-avatar"><i class="fas fa-user"></i></div>
                <div class="message-content">
                    <div class="message-text">${messageText}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(userMessage);

            // Add thinking animation
            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'thinking-indicator';
            thinkingIndicator.innerHTML = `
                <div class="thinking-spinner">
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                </div>
            `;
            chatMessages.appendChild(thinkingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Disable send button
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // Retrieve relevant documents
                const relevantDocs = await retrieveDocuments(messageText);

                // Prepare messages for API
                const messages = [
                    {
                        role: 'system',
                        content: `You are HELPER GPT, a personal tutor and assistance provider powered by Meta Llama 3.2 11B Vision Instruct. Provide clear, concise, and accurate responses tailored for students. Solve math and science problems with step-by-step explanations. Analyze images and documents to answer related questions. Summarize topics clearly and explain complex concepts in detail. Assist with homework, assignments, projects, and coding tasks. Avoid emojis, markdown, and unnecessary symbols. Use context from uploaded materials if available, otherwise rely on general knowledge.`
                    },
                    {
                        role: 'user',
                        content: messageText + (relevantDocs.length > 0 ? `\n\nContext from uploaded materials:\n${relevantDocs.map(doc => doc.content).join('\n\n')}` : '')
                    }
                ];

                // Add image data if available
                relevantDocs.forEach(doc => {
                    if (doc.base64) {
                        messages.push({
                            role: 'user',
                            content: [
                                { type: 'text', text: 'This is an image from the study materials.' },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${doc.base64}` } }
                            ]
                        });
                    }
                });

                // Make API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://helper-srm.com',
                        'X-Title': 'HELPER GPT'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages,
                        max_tokens: 500,
                        temperature: 0.6,
                        top_p: 0.95
                    })
                });

                const data = await response.json();
                const reply = data.choices?.[0]?.message?.content || 'No response generated.';

                // Remove thinking animation
                thinkingIndicator.remove();

                // Add bot response
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">
                        <div class="message-text">${reply}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatMessages.appendChild(botMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Generation error:', error);
                thinkingIndicator.remove();
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">
                        <div class="message-text">Sorry, an error occurred while generating the response. Please try again.</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatMessages.appendChild(botMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            chatInput.value = '';
        }

        async function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function insertSuggestion(text) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = text;
            chatInput.focus();
        }
    </script>
</body>
</html>