<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELPER GPT - AI Study Assistant | SRM Verse</title>
    <link rel="stylesheet" href="css/unified-theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* AI Assistant specific styles */
        .chat-wrapper {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            gap: 2rem;
        }

        .chat-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .chat-header h1 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0.5rem 0 0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 75%;
            align-self: flex-start;
        }

        .message.user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .message.user-message .message-content {
            background: var(--primary-gradient);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            align-self: flex-end;
            margin-top: 0.25rem;
        }

        .thinking-indicator {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .thinking-spinner {
            display: flex;
            gap: 8px;
        }

        .thinking-dot {
            width: 12px;
            height: 12px;
            background: var(--primary-gradient);
            border-radius: 50%;
            animation: thinking 1.2s ease-in-out infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 100% { transform: scale(0.5); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .chat-input-container {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.75rem;
        }

        .chat-input-wrapper textarea {
            flex-grow: 1;
            resize: none;
            border: none;
            padding: 0.75rem;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: transparent;
            color: var(--white);
            min-height: 40px;
            max-height: 120px;
            line-height: 1.5;
        }

        .chat-input-wrapper textarea:focus {
            outline: none;
        }

        .chat-input-wrapper textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            background: var(--primary-gradient);
            border: none;
            color: var(--white);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-blue);
        }

        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .input-suggestions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .suggestion-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .hamburger {
            display: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
        }

        @media (max-width: 768px) {
            .hamburger { display: block; }
            .nav-menu { 
                display: none; 
                flex-direction: column; 
                width: 100%; 
                background: rgba(15, 15, 35, 0.95); 
                backdrop-filter: blur(20px);
                box-shadow: var(--shadow-lg); 
                padding: 1rem; 
                position: absolute; 
                top: 80px; 
                left: 0; 
                z-index: 999; 
            }
            .nav-menu.active { display: flex; }
            .nav-link { 
                width: 100%; 
                justify-content: center; 
                padding: 1rem; 
                font-size: 1rem; 
            }
            .nav-link span { display: none; }
            .chat-container { height: calc(100vh - 200px); }
            .chat-messages { padding: 1rem; }
            .message { max-width: 90%; }
            .message-content { padding: 0.75rem 1rem; font-size: 0.9rem; }
            .chat-input-wrapper { padding: 0.5rem; }
            .send-btn { width: 36px; height: 36px; font-size: 0.9rem; }
            .input-suggestions { gap: 0.5rem; }
            .suggestion-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .chat-container { height: calc(100vh - 180px); }
            .chat-messages { padding: 0.75rem; }
            .message { max-width: 95%; }
            .message-content { padding: 0.5rem 0.75rem; }
            .chat-input-wrapper textarea { min-height: 35px; }
            .send-btn { width: 32px; height: 32px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="glow-orb glow-orb-1"></div>
        <div class="glow-orb glow-orb-2"></div>
        <div class="glow-orb glow-orb-3"></div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>SRM Verse</span>
            </div>
            <i class="fas fa-bars hamburger" id="hamburger"></i>
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link" aria-label="Dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="materials-simple.html" class="nav-link" aria-label="Materials">
                    <i class="fas fa-book"></i>
                    <span>Materials</span>
                </a>
                <a href="gpa-simple.html" class="nav-link" aria-label="GPA Calculator">
                    <i class="fas fa-calculator"></i>
                    <span>GPA</span>
                </a>
                <a href="attendance-calculator.html" class="nav-link" aria-label="Attendance Tracker">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                </a>
                <a href="pomodoro-timer.html" class="nav-link" aria-label="Pomodoro Timer">
                    <i class="fas fa-clock"></i>
                    <span>Timer</span>
                </a>
                <a href="ai-assistant.html" class="nav-link active" aria-label="HELPER GPT">
                    <i class="fas fa-robot"></i>
                    <span>HELPER GPT</span>
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content" role="main" aria-label="HELPER GPT">
        <div class="chat-wrapper">
            <section class="chat-container" aria-live="polite" aria-atomic="false" aria-relevant="additions">
                <div class="chat-header">
                    <h1><i class="fas fa-robot"></i> HELPER GPT - AI Study Assistant</h1>
                    <p>Powered by Llama 3.3 70B Versatile. Ask me anything about your studies!</p>
                </div>
                <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                    <div class="message bot-message" role="article" aria-label="Assistant message">
                        <div class="message-content">
                            <div class="message-text">
                                Hello! I'm HELPER GPT, your personal AI tutor. I can assist with math and science problems, explain complex concepts, summarize topics, help with homework and projects, write code, and answer any academic questions you have. What would you like to learn about today?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            id="chatInput"
                            placeholder="Ask HELPER GPT anything about your studies..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            aria-label="Chat input"
                            autocomplete="off"
                            spellcheck="true"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" aria-label="Send message" title="Send message" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-suggestions" role="list" aria-label="Suggested questions">
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Explain a complex concept')">
                            Explain concept
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Help me solve this math problem')">
                            Solve problem
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Write code for this task')">
                            Write code
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Help with my homework')">
                            Homework help
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
    // API configuration - now calling your own Vercel serverless function
    const LOCAL_API_URL = '/api/chat'; // This is the path to your new serverless function (api/chat.js)
    // const MODEL = 'llama-3.3-70b-versatile'; // This model variable is no longer strictly needed on the frontend,
                                             // as your serverless function will specify the model.

    document.getElementById('hamburger').addEventListener('click', () => {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.toggle('active');
    });

    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            document.getElementById('navMenu').classList.remove('active');
        });
    });

    const chatMessages = document.getElementById('chatMessages');
    const sendBtn = document.getElementById('sendBtn');

    async function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const messageText = chatInput.value.trim();
        if (!messageText) return;

        // Add user message to chat
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.innerHTML = `
            <div class="message-content">
                <div class="message-text">${messageText}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            </div>
        `;
        chatMessages.appendChild(userMessage);

        // Add thinking indicator
        const thinkingIndicator = document.createElement('div');
        thinkingIndicator.className = 'thinking-indicator';
        thinkingIndicator.innerHTML = `
            <div class="thinking-spinner">
                <span class="thinking-dot"></span>
                <span class="thinking-dot"></span>
                <span class="thinking-dot"></span>
            </div>
        `;
        chatMessages.appendChild(thinkingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Disable send button
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            // Modified fetch call to point to your Vercel serverless function
            const response = await fetch(LOCAL_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: messageText // Only send the user's message, the serverless function handles the rest
                })
            });

            const data = await response.json(); // Parse the JSON response from your serverless function
            
            if (response.status !== 200) {
                // If your serverless function returned an error status (e.g., 400, 500)
                throw new Error(data.error || 'Unknown error from serverless function');
            }

            const reply = data.reply; // Your serverless function sends the AI's response in a 'reply' field

            // Remove thinking indicator
            thinkingIndicator.remove();

            // Add bot response with formatted content
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            botMessage.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${formatResponse(reply)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(botMessage);
            
            // Add copy buttons to code blocks
            addCopyButtons(botMessage);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;

        } catch (error) {
            console.error('Generation error:', error);
            thinkingIndicator.remove();
            
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            botMessage.innerHTML = `
                <div class="message-content">
                    <div class="message-text">Sorry, I encountered an error while processing your request. Please try again.</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(botMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Re-enable send button
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        chatInput.value = '';
    }

    async function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function insertSuggestion(text) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = text;
        chatInput.focus();
    }

    // Auto-resize textarea
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Format response text with enhanced styling
    function formatResponse(text) {
        // Escape HTML first
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Format code blocks (```code```)
        text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
            return `<pre><code>${code.trim()}</code></pre>`;
        });
        
        // Format inline code (`code`)
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Format bold text (**text**)
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Format italic text (*text*)
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Format headers (## Header) - order matters for replacement
        text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
        text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
        text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
        
        // Format step-by-step solutions
        if (text.includes('Step ') || text.includes('step ')) {
            text = text.replace(/(Step \d+:|step \d+:)/gi, '<span class="step-number">$1</span>');
        }
        
        // Format mathematical expressions (wrap in math class)
        // Assuming your backend will send actual LaTeX if needed, otherwise this is a simple visual wrapper
        text = text.replace(/(\$.*?\$)/g, '<span class="math-expression">$1</span>');
        
        // Format lists (before paragraphs to avoid double wrapping)
        const listItemsRegex = /^(?:[*-]|\d+\.)\s+(.*(?:[\r\n](?![*-]|\d+\.)\s+.*)*)/gm;
        const tempLists = [];
        text = text.replace(listItemsRegex, (match, content) => {
            const marker = match.match(/^(?:[*-]|\d+\.)/)[0];
            const type = marker.includes('*') || marker.includes('-') ? 'ul' : 'ol';
            const listItem = `<li>${content.trim()}</li>`;
            
            if (tempLists.length > 0 && tempLists[tempLists.length - 1].type === type) {
                tempLists[tempLists.length - 1].items.push(listItem);
            } else {
                tempLists.push({ type, items: [listItem] });
            }
            return 'TEMP_LIST_PLACEHOLDER_' + (tempLists.length - 1);
        });

        tempLists.forEach((list, index) => {
            text = text.replace('TEMP_LIST_PLACEHOLDER_' + index, `<${list.type}>${list.items.join('')}</${list.type}>`);
        });
        
        // Format paragraphs (after lists and other block elements)
        text = text.split('\n\n').map(paragraph => {
            if (paragraph.trim() === '' || paragraph.startsWith('<h') || paragraph.startsWith('<pre') || paragraph.startsWith('<ul') || paragraph.startsWith('<ol') || paragraph.startsWith('<blockquote') || paragraph.startsWith('<div')) {
                return paragraph; // Don't wrap already formatted blocks or empty lines
            }
            // Handle single newlines as <br> within a paragraph, double newlines create new paragraphs
            return `<p>${paragraph.replace(/\n/g, '<br>')}</p>`;
        }).join('');
        
        // Clean up empty paragraphs
        text = text.replace(/<p><\/p>/g, '').replace(/<p>\s*<\/p>/g, '');
        
        // Format blockquotes (> text)
        text = text.replace(/^&gt;\s+(.*)$/gm, '<blockquote>$1</blockquote>');
        
        // Highlight important terms (this should be after initial escaping, but before final HTML parsing)
        text = text.replace(/\b(important|note|warning|remember|key point)\b/gi, '<span class="highlight">$1</span>');
        
        return text;
    }

    // Add copy buttons to code blocks
    function addCopyButtons(messageElement) {
        const codeBlocks = messageElement.querySelectorAll('pre');
        codeBlocks.forEach(block => {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.title = 'Copy code';
            copyBtn.onclick = () => {
                const code = block.querySelector('code').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 2000);
                });
            };
            block.appendChild(copyBtn);
        });
    }
</script>
</body>
</html>
