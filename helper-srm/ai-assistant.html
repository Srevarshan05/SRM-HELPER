<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELPER Bot - AI Study Assistant | HELPER SRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-gradient: linear-gradient(135deg, #2563eb, #4f46e5);
            --success-gradient: linear-gradient(135deg, #22c55e, #16a34a);
            --secondary-gradient: linear-gradient(135deg, #f87171, #ef4444);
            --white: #ffffff;
            --black: #1f2937;
            --dark-gray: #4b5563;
            --medium-gray: #d1d5db;
            --light-gray: #f3f4f6;
            --accent-blue: #3b82f6;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --font-family: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--black);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-sm) var(--space-md);
        }

        .navbar {
            background: var(--white);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--black);
            text-decoration: none;
        }

        .nav-brand i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: var(--font-size-2xl);
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--dark-gray);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: var(--light-gray);
            color: var(--accent-blue);
        }

        .nav-link.active {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            padding: var(--space-sm);
        }

        .assistant-header {
            text-align: center;
            margin-bottom: var(--space-2xl);
            background: var(--white);
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }

        .assistant-header h1 {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--black);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
        }

        .assistant-header h1 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .assistant-header p {
            font-size: var(--font-size-lg);
            color: var(--dark-gray);
        }

        .chat-container {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            height: 600px;
            overflow: hidden;
            margin-bottom: var(--space-2xl);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-md) var(--space-lg);
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            max-width: 80%;
        }

        .message.user-message {
            margin-left: auto;
            flex-direction: row-reverse;
            text-align: right;
        }

        .message.bot-message {
            margin-right: auto;
        }

        .message-avatar {
            background: var(--primary-gradient);
            color: var(--white);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .message.user-message .message-avatar {
            background: var(--secondary-gradient);
        }

        .message-content {
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-base);
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user-message .message-content {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .message-time {
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            margin-top: var(--space-xs);
            user-select: none;
        }

        .message.user-message .message-time {
            color: var(--light-gray);
        }

        .typing-indicator .typing-dots {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: flex-start;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        .file-upload-area {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin: var(--space-md) var(--space-lg);
            text-align: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            user-select: none;
            position: relative;
        }

        .file-upload-area.dragover {
            border-color: var(--accent-blue);
            background-color: var(--light-gray);
            color: var(--accent-blue);
        }

        .file-upload-area i {
            font-size: 2.5rem;
            margin-bottom: var(--space-sm);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .file-upload-area p {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            font-size: var(--font-size-base);
        }

        .file-upload-area span {
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }

        .uploaded-files-list {
            max-height: 120px;
            overflow-y: auto;
            margin: 0 var(--space-lg) var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            font-size: var(--font-size-sm);
            color: var(--black);
        }

        .uploaded-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .uploaded-file-item:last-child {
            border-bottom: none;
        }

        .uploaded-file-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-file-btn {
            background: transparent;
            border: none;
            color: var(--secondary-gradient);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0 var(--space-xs);
            transition: color 0.3s ease;
        }

        .remove-file-btn:hover {
            color: #c53030;
        }

        .chat-input-container {
            border-top: 1px solid var(--medium-gray);
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            display: flex;
            flex-direction: column;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .chat-input-wrapper textarea {
            flex-grow: 1;
            resize: none;
            border-radius: var(--radius-md);
            border: 2px solid var(--medium-gray);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            transition: border-color 0.3s ease;
            min-height: 40px;
            max-height: 120px;
        }

        .chat-input-wrapper textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .attachment-btn, .send-btn {
            background: var(--primary-gradient);
            border: none;
            color: var(--white);
            border-radius: var(--radius-md);
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .attachment-btn:hover, .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .attachment-btn:active, .send-btn:active {
            transform: translateY(0);
        }

        .input-suggestions {
            margin-top: var(--space-sm);
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            justify-content: center;
        }

        .suggestion-btn {
            background: var(--light-gray);
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            color: var(--black);
            transition: background-color 0.3s ease;
            font-weight: 500;
        }

        .suggestion-btn:hover {
            background: var(--medium-gray);
        }

        .ai-features {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
            margin-top: var(--space-2xl);
        }

        .ai-features h3 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--black);
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-md);
        }

        .feature-card {
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-md);
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 2.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-sm);
        }

        .feature-content h4 {
            font-weight: 600;
            font-size: var(--font-size-base);
            margin-bottom: var(--space-xs);
            color: var(--black);
        }

        .feature-content p {
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            line-height: 1.3;
        }

        .api-config {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
            margin-top: var(--space-2xl);
        }

        .api-config h3 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--black);
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .config-form {
            max-width: 700px;
            margin: 0 auto;
        }

        .config-row {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
            justify-content: center;
        }

        .config-item {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
            margin-bottom: var(--space-md);
        }

        .config-item label {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--black);
            font-size: var(--font-size-sm);
        }

        .config-item select,
        .config-item input {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            border: 2px solid var(--medium-gray);
            font-size: var(--font-size-base);
            transition: border-color 0.3s ease;
        }

        .config-item select:focus,
        .config-item input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .config-status {
            margin-top: var(--space-sm);
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .config-status.success {
            color: #16a34a;
        }

        .config-status i {
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 80px;
                left: 0;
                width: 100%;
                background: var(--white);
                box-shadow: var(--shadow-md);
                padding: var(--space-md);
                z-index: 999;
            }

            .nav-menu.active {
                display: flex;
            }

            .nav-link {
                width: 100%;
                justify-content: center;
                padding: var(--space-md);
                font-size: var(--font-size-base);
            }

            .hamburger {
                display: block;
            }

            .container {
                padding: var(--space-sm);
            }

            .assistant-header {
                padding: var(--space-lg);
            }

            .assistant-header h1 {
                font-size: var(--font-size-2xl);
            }

            .assistant-header p {
                font-size: var(--font-size-sm);
            }

            .chat-container {
                height: 500px;
            }

            .chat-messages {
                padding: var(--space-sm) var(--space-md);
            }

            .message {
                max-width: 90%;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 1.1rem;
            }

            .message-content {
                padding: var(--space-sm);
                font-size: var(--font-size-sm);
            }

            .file-upload-area {
                margin: var(--space-sm) var(--space-md);
                padding: var(--space-md);
            }

            .file-upload-area i {
                font-size: 2rem;
            }

            .uploaded-files-list {
                margin: 0 var(--space-md) var(--space-sm);
                padding: var(--space-xs) var(--space-sm);
            }

            .chat-input-wrapper textarea {
                font-size: var(--font-size-sm);
                padding: var(--space-xs) var(--space-sm);
            }

            .attachment-btn, .send-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .input-suggestions {
                gap: var(--space-xs);
            }

            .suggestion-btn {
                padding: var(--space-xs) var(--space-sm);
                font-size: var(--font-size-sm);
            }

            .ai-features {
                padding: var(--space-lg);
            }

            .ai-features h3 {
                font-size: var(--font-size-lg);
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }

            .feature-card {
                padding: var(--space-sm);
            }

            .feature-icon {
                font-size: 2rem;
            }

            .api-config {
                padding: var(--space-lg);
            }

            .api-config h3 {
                font-size: var(--font-size-lg);
            }

            .config-row {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }

            .config-item {
                margin-bottom: var(--space-sm);
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                height: 450px;
            }

            .message {
                max-width: 95%;
            }

            .message-avatar {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }

            .message-content {
                padding: var(--space-xs) var(--space-sm);
            }

            .message-time {
                font-size: 0.75rem;
            }

            .file-upload-area p {
                font-size: var(--font-size-sm);
            }

            .file-upload-area span {
                font-size: 0.75rem;
            }

            .chat-input-wrapper textarea {
                min-height: 35px;
            }

            .attachment-btn, .send-btn {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>HELPER SRM</span>
            </div>
            <i class="fas fa-bars hamburger" id="hamburger"></i>
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link" aria-label="Dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="semesters.html" class="nav-link" aria-label="Materials">
                    <i class="fas fa-book"></i>
                    <span>Materials</span>
                </a>
                <a href="gpa-simple.html" class="nav-link" aria-label="GPA Calculator">
                    <i class="fas fa-calculator"></i>
                    <span>GPA</span>
                </a>
                <a href="attendance-calculator.html" class="nav-link" aria-label="Attendance Calculator">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                </a>
                <a href="pomodoro-timer.html" class="nav-link" aria-label="Pomodoro Timer">
                    <i class="fas fa-clock"></i>
                    <span>Timer</span>
                </a>
                <a href="ai-assistant.html" class="nav-link active" aria-label="AI Assistant">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content" role="main" aria-label="AI Study Assistant">
        <div class="container">
            <header class="assistant-header">
                <h1><i class="fas fa-robot"></i> HELPER Bot - AI Study Assistant</h1>
                <p>Upload your study materials and MSEX 1.0 Flash supports text and image inputs, ideal for processing study materials and answering queries. and images and ask questions. HELPER Bot will assist you based on your materials!</p>[](https://codemaker2016.medium.com/build-your-own-chatgpt-using-google-gemini-api-1b079f6a8415)
            </header>

            <section class="chat-container" aria-live="polite" aria-atomic="false" aria-relevant="additions">
                <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                    <div class="message bot-message" role="article" aria-label="Assistant message">
                        <div class="message-avatar" aria-hidden="true">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Hello! I'm HELPER Bot, your AI Study Assistant. I can help you with:
                                <ul>
                                    <li>üìö Explaining concepts from your study materials</li>
                                    <li>‚ùì Answering questions about your subjects</li>
                                    <li>üìù Helping with assignments and homework</li>
                                    <li>üßÆ Solving math and science problems</li>
                                    <li>üìñ Summarizing complex topics</li>
                                </ul>
                                Upload your documents or images and ask me anything!
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>

                <div class="uploaded-files-list" id="uploadedFilesList" aria-label="Uploaded study materials list" tabindex="0" hidden>
                </div>

                <div class="file-upload-area" id="fileUploadArea" tabindex="0" role="button" aria-label="Upload study materials">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                        <p>Drag & drop files here or click to upload</p>
                        <span>Supports PDF, DOC, DOCX, TXT, PNG, JPG, JPEG</span>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;" aria-hidden="true">
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <button class="attachment-btn" aria-label="Attach files" title="Attach files" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <textarea
                            id="chatInput"
                            placeholder="Ask me anything about your studies..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            aria-label="Chat input"
                            autocomplete="off"
                            spellcheck="true"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" aria-label="Send message" title="Send message" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-suggestions" role="list" aria-label="Suggested questions">
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Explain this concept to me')">
                            Explain concept
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Help me solve this problem')">
                            Solve problem
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Summarize this topic')">
                            Summarize topic
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Create study notes')">
                            Create notes
                        </button>
                    </div>
                </div>
            </section>

            <section class="ai-features" aria-label="AI Assistant Features">
                <h3>AI Assistant Features</h3>
                <div class="features-grid">
                    <article class="feature-card" tabindex="0" aria-label="Smart Analysis feature">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="feature-content">
                            <h4>Smart Analysis</h4>
                            <p>Upload your documents and get instant analysis, summaries, and explanations</p>
                        </div>
                    </article>
                    <article class="feature-card" tabindex="0" aria-label="Q&A Support feature">
                        <div class="feature-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="feature-content">
                            <h4>Q&A Support</h4>
                            <p>Ask questions about any topic and get detailed, accurate answers</p>
                        </div>
                    </article>
                    <article class="feature-card" tabindex="0" aria-label="Study Tips feature">
                        <div class="feature-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="feature-content">
                            <h4>Study Tips</h4>
                            <p>Get personalized study strategies and learning recommendations</p>
                        </div>
                    </article>
                    <article class="feature-card" tabindex="0" aria-label="Problem Solving feature">
                        <div class="feature-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="feature-content">
                            <h4>Problem Solving</h4>
                            <p>Step-by-step solutions for math, physics, and engineering problems</p>
                        </div>
                    </article>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // Gemini API Key (provided by user)
        const GEMINI_API_KEY = 'AIzaSyAQYuGmfklei5ssEXVUXG3L9TA3dgndKLg';

        // Navigation toggle
        document.getElementById('hamburger').addEventListener('click', () => {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navMenu').classList.remove('active');
            });
        });

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        let documents = []; // Store extracted text, embeddings, and base64 images

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        async function handleFiles(files) {
            uploadedFilesList.removeAttribute('hidden');
            for (let file of files) {
                if (file.type.match(/^(application\/(pdf|msword|vnd\.openxmlformats-officedocument\.wordprocessingml\.document)|text\/plain|image\/(png|jpeg))$/)) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'uploaded-file-item';
                    fileItem.innerHTML = `
                        <span class="uploaded-file-name">${file.name}</span>
                        <button class="remove-file-btn" aria-label="Remove ${file.name}" title="Remove file">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    uploadedFilesList.appendChild(fileItem);
                    fileItem.querySelector('.remove-file-btn').addEventListener('click', () => {
                        fileItem.remove();
                        documents = documents.filter(doc => doc.name !== file.name);
                        if (!uploadedFilesList.children.length) {
                            uploadedFilesList.setAttribute('hidden', '');
                        }
                    });

                    // Process file
                    const content = await processFile(file);
                    if (content) {
                        // For images, store base64 data
                        let base64Data = null;
                        if (file.type.startsWith('image/')) {
                            base64Data = await fileToBase64(file);
                        }
                        // Split content into chunks (500 characters)
                        const chunks = chunkText(content, 500);
                        for (let i = 0; i < chunks.length; i++) {
                            const embedding = await getEmbedding(chunks[i]);
                            documents.push({ name: `${file.name}_chunk_${i}`, content: chunks[i], embedding, base64: base64Data });
                        }
                    }
                } else {
                    alert('Unsupported file type: ' + file.name);
                }
            }
            fileInput.value = '';
        }

        function chunkText(text, maxLength) {
            const chunks = [];
            for (let i = 0; i < text.length; i += maxLength) {
                chunks.push(text.slice(i, i + maxLength));
            }
            return chunks;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processFile(file) {
            try {
                if (file.type.startsWith('image/')) {
                    // Process image with Gemini API
                    const base64Data = await fileToBase64(file);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: 'Describe the content of this image in detail.' },
                                    { inlineData: { mimeType: file.type, data: base64Data } }
                                ]
                            }]
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        console.error('Image processing error:', result.error);
                        return 'Image processing failed';
                    }
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || 'Image processing failed';
                } else if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + ' ';
                    }
                    return text || 'PDF content extraction failed';
                } else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    return result.value || 'Document content extraction failed';
                } else if (file.type === 'text/plain') {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => resolve('Text file reading failed');
                        reader.readAsText(file);
                    });
                }
            } catch (error) {
                console.error('File processing error:', error);
                return null;
            }
            return null;
        }

        async function getEmbedding(text) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: { parts: [{ text }] } })
                });
                const result = await response.json();
                if (result.error) {
                    console.error('Embedding error:', result.error);
                    return [];
                }
                return result.embedding?.values || [];
            } catch (error) {
                console.error('Embedding error:', error);
                return [];
            }
        }

        function cosineSimilarity(vecA, vecB) {
            if (!vecA.length || !vecB.length) return 0;
            const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
            const normA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const normB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            return normA * normB ? dotProduct / (normA * normB) : 0;
        }

        async function retrieveDocuments(query) {
            const queryEmbedding = await getEmbedding(query);
            return documents
                .map(doc => ({ ...doc, score: cosineSimilarity(queryEmbedding, doc.embedding) }))
                .filter(doc => doc.score > 0.5)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
        }

        async function generateResponse(query, context) {
            try {
                const parts = [
                    {
                        text: `
                            You are HELPER Bot, an AI study assistant. Use the following context from uploaded study materials to answer the user's question accurately and concisely. If the context is insufficient, provide a general answer based on your knowledge, but prioritize the context. Keep responses clear, educational, and student-friendly.

                            **Context**:
                            ${context.map(doc => doc.content).join('\n\n')}

                            **Question**:
                            ${query}

                            **Answer**:
                        `
                    }
                ];

                // Add image data if available
                context.forEach(doc => {
                    if (doc.base64) {
                        parts.push({ inlineData: { mimeType: 'image/jpeg', data: doc.base64 } });
                    }
                });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { maxOutputTokens: 500, temperature: 0.7 }
                    })
                });
                const result = await response.json();
                if (result.error) {
                    console.error('Generation error:', result.error);
                    return 'Sorry, I couldn‚Äôt generate a response. Please check your API key or try again later.';
                }
                return result.candidates?.[0]?.content?.parts?.[0]?.text || 'No response generated.';
            } catch (error) {
                console.error('Generation error:', error);
                return 'Sorry, an error occurred while generating the response. Please try again.';
            }
        }

        async function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            // Add user message
            const chatMessages = document.getElementById('chatMessages');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="message-avatar"><i class="fas fa-user"></i></div>
                <div class="message-content">
                    <div class="message-text">${messageText}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(userMessage);

            // Add typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message bot-message typing-indicator';
            typingIndicator.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Retrieve and generate response
            const relevantDocs = await retrieveDocuments(messageText);
            const responseText = await generateResponse(messageText, relevantDocs);

            // Remove typing indicator
            typingIndicator.remove();

            // Add bot response
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            botMessage.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="message-text">${responseText}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(botMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            chatInput.value = '';
        }

        function insertSuggestion(text) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = text;
            chatInput.focus();
        }
    </script>
</body>
</html>