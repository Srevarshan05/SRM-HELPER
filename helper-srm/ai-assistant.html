<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELPER GPT - AI Study Assistant | SRM Verse</title>
    <link rel="stylesheet" href="css/unified-theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js"></script>
    <style>
        /* AI Assistant specific styles */
        .chat-wrapper {
            display: flex;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            gap: 2rem;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: fit-content;
        }

        .sidebar-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--white);
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .file-upload-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            color: var(--white);
        }

        .file-upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .file-upload-area i {
            font-size: 2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            display: block;
        }

        .file-upload-area p {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--white);
        }

        .file-upload-area span {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .uploaded-files-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
            max-height: 300px;
        }

        .uploaded-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .uploaded-file-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .uploaded-file-name {
            flex-grow: 1;
            font-size: 0.9rem;
            color: var(--white);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-file-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .remove-file-btn:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-container {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .chat-header h1 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0.5rem 0 0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 75%;
            align-self: flex-start;
        }

        .message.user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .message.user-message .message-content {
            background: var(--primary-gradient);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            align-self: flex-end;
            margin-top: 0.25rem;
        }

        .thinking-indicator {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .thinking-spinner {
            display: flex;
            gap: 8px;
        }

        .thinking-dot {
            width: 12px;
            height: 12px;
            background: var(--primary-gradient);
            border-radius: 50%;
            animation: thinking 1.2s ease-in-out infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinking {
            0%, 100% { transform: scale(0.5); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .chat-input-container {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.75rem;
        }

        .chat-input-wrapper textarea {
            flex-grow: 1;
            resize: none;
            border: none;
            padding: 0.75rem;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: transparent;
            color: var(--white);
            min-height: 40px;
            max-height: 120px;
            line-height: 1.5;
        }

        .chat-input-wrapper textarea:focus {
            outline: none;
        }

        .chat-input-wrapper textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .attachment-btn, .send-btn {
            background: var(--primary-gradient);
            border: none;
            color: var(--white);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .attachment-btn:hover, .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-blue);
        }

        .attachment-btn:disabled, .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .input-suggestions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .suggestion-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .hamburger {
            display: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
        }

        @media (max-width: 768px) {
            .hamburger { display: block; }
            .nav-menu { 
                display: none; 
                flex-direction: column; 
                width: 100%; 
                background: rgba(15, 15, 35, 0.95); 
                backdrop-filter: blur(20px);
                box-shadow: var(--shadow-lg); 
                padding: 1rem; 
                position: absolute; 
                top: 80px; 
                left: 0; 
                z-index: 999; 
            }
            .nav-menu.active { display: flex; }
            .nav-link { 
                width: 100%; 
                justify-content: center; 
                padding: 1rem; 
                font-size: 1rem; 
            }
            .nav-link span { display: none; }
            .chat-wrapper { flex-direction: column; }
            .sidebar { width: 100%; max-height: 250px; }
            .uploaded-files-list { max-height: 120px; }
            .chat-container { height: calc(100vh - 300px); }
            .chat-messages { padding: 1rem; }
            .message { max-width: 90%; }
            .message-content { padding: 0.75rem 1rem; font-size: 0.9rem; }
            .chat-input-wrapper { padding: 0.5rem; }
            .attachment-btn, .send-btn { width: 36px; height: 36px; font-size: 0.9rem; }
            .input-suggestions { gap: 0.5rem; }
            .suggestion-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .chat-container { height: calc(100vh - 280px); }
            .chat-messages { padding: 0.75rem; }
            .message { max-width: 95%; }
            .message-content { padding: 0.5rem 0.75rem; }
            .chat-input-wrapper textarea { min-height: 35px; }
            .attachment-btn, .send-btn { width: 32px; height: 32px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="glow-orb glow-orb-1"></div>
        <div class="glow-orb glow-orb-2"></div>
        <div class="glow-orb glow-orb-3"></div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>SRM Verse</span>
            </div>
            <i class="fas fa-bars hamburger" id="hamburger"></i>
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link" aria-label="Dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="semesters.html" class="nav-link" aria-label="Materials">
                    <i class="fas fa-book"></i>
                    <span>Materials</span>
                </a>
                <a href="gpa-simple.html" class="nav-link" aria-label="GPA Calculator">
                    <i class="fas fa-calculator"></i>
                    <span>GPA</span>
                </a>
                <a href="attendance-calculator.html" class="nav-link" aria-label="Attendance Tracker">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance Tracker</span>
                </a>
                <a href="pomodoro-timer.html" class="nav-link" aria-label="Pomodoro Timer">
                    <i class="fas fa-clock"></i>
                    <span>Timer</span>
                </a>
                <a href="ai-assistant.html" class="nav-link active" aria-label="HELPER GPT">
                    <i class="fas fa-robot"></i>
                    <span>HELPER GPT</span>
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content" role="main" aria-label="HELPER GPT">
        <div class="chat-wrapper">
            <div class="sidebar" aria-label="Study Materials">
                <div class="sidebar-header">Uploaded Study Materials</div>
                <div class="file-upload-area" id="fileUploadArea" tabindex="0" role="button" aria-label="Upload study materials">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                        <p>Upload Study Materials</p>
                        <span>PDF, DOC, DOCX, TXT, PNG, JPG, JPEG</span>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;" aria-hidden="true">
                </div>
                <div class="uploaded-files-list" id="uploadedFilesList" aria-label="Uploaded study materials list" tabindex="0"></div>
            </div>
            <section class="chat-container" aria-live="polite" aria-atomic="false" aria-relevant="additions">
                <div class="chat-header">
                    <h1><i class="fas fa-robot"></i> HELPER GPT - AI Study Assistant</h1>
                    <p>Powered by Meta Llama 3.2 11B Vision Instruct. Ask questions about your study materials!</p>
                </div>
                <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                    <div class="message bot-message" role="article" aria-label="Assistant message">
                        <div class="message-content">
                            <div class="message-text">
                                Hello! I'm HELPER GPT, your personal tutor. I can assist with math and science problems, explain complex concepts, summarize topics, help with homework and projects, and write code. Upload study materials or ask a question to get started.
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <button class="attachment-btn" aria-label="Attach files" title="Attach files" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <textarea
                            id="chatInput"
                            placeholder="Ask HELPER GPT about your study materials..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            aria-label="Chat input"
                            autocomplete="off"
                            spellcheck="true"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" aria-label="Send message" title="Send message" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-suggestions" role="list" aria-label="Suggested questions">
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Explain this concept from my notes')">
                            Explain concept
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Help me solve this problem')">
                            Solve problem
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Summarize my uploaded document')">
                            Summarize document
                        </button>
                        <button class="suggestion-btn" role="listitem" onclick="insertSuggestion('Write code for this task')">
                            Write code
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        const OPENROUTER_API_KEY = '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';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const EMBEDDING_URL = 'https://openrouter.ai/api/v1/embeddings';
        const MODEL = 'meta-llama/llama-3.2-11b-vision-instruct:free';
        const EMBEDDING_MODEL = 'nomic-embed-text';

        document.getElementById('hamburger').addEventListener('click', () => {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navMenu').classList.remove('active');
            });
        });

        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const chatMessages = document.getElementById('chatMessages');
        const sendBtn = document.getElementById('sendBtn');
        let documents = [];

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        async function handleFiles(files) {
            for (let file of files) {
                if (file.type.match(/^(application\/(pdf|msword|vnd\.openxmlformats-officedocument\.wordprocessingml\.document)|text\/plain|image\/(png|jpeg))$/)) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'uploaded-file-item';
                    fileItem.innerHTML = `
                        <span class="uploaded-file-name">${file.name}</span>
                        <button class="remove-file-btn" aria-label="Remove ${file.name}" title="Remove file">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    uploadedFilesList.appendChild(fileItem);
                    fileItem.querySelector('.remove-file-btn').addEventListener('click', () => {
                        fileItem.remove();
                        documents = documents.filter(doc => doc.name !== file.name);
                    });

                    const content = await processFile(file);
                    if (content) {
                        let base64Data = null;
                        if (file.type.startsWith('image/')) {
                            base64Data = await getImageBase64(file);
                        }
                        const chunks = chunkText(content, 500);
                        for (let i = 0; i < chunks.length; i++) {
                            const embedding = await getEmbedding(chunks[i]);
                            documents.push({ name: `${file.name}_chunk_${i}`, content: chunks[i], embedding, base64: base64Data });
                        }
                    }
                } else {
                    alert('Unsupported file type: ' + file.name);
                }
            }
            fileInput.value = '';
        }

        function chunkText(text, maxLength) {
            const chunks = [];
            for (let i = 0; i < text.length; i += maxLength) {
                chunks.push(text.slice(i, i + maxLength));
            }
            return chunks;
        }

        async function getImageBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processFile(file) {
            try {
                if (file.type.startsWith('image/')) {
                    const base64Data = await getImageBase64(file);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': 'https://helper-srm.com',
                            'X-Title': 'HELPER GPT'
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are HELPER GPT, a personal tutor and assistance provider. Analyze the provided image and describe its content in detail to assist with student queries. Provide clear, concise, and accurate descriptions without emojis or unnecessary symbols.'
                                },
                                {
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: 'Describe the content of this image in detail.' },
                                        { type: 'image_url', image_url: { url: `data:${file.type};base64,${base64Data}` } }
                                    ]
                                }
                            ]
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        console.error('Image processing error:', result.error);
                        return 'Image processing failed';
                    }
                    return result.choices?.[0]?.message?.content || 'Image processing failed';
                } else if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + ' ';
                    }
                    return text || 'PDF content extraction failed';
                } else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    return result.value || 'Document content extraction failed';
                } else if (file.type === 'text/plain') {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => resolve('Text file reading failed');
                        reader.readAsText(file);
                    });
                }
            } catch (error) {
                console.error('File processing error:', error);
                return null;
            }
            return null;
        }

        async function getEmbedding(text) {
            try {
                const response = await fetch(EMBEDDING_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://helper-srm.com',
                        'X-Title': 'HELPER GPT'
                    },
                    body: JSON.stringify({
                        model: EMBEDDING_MODEL,
                        input: text
                    })
                });
                const result = await response.json();
                if (result.error) {
                    console.error('Embedding error:', result.error);
                    return [];
                }
                return result.data?.[0]?.embedding || [];
            } catch (error) {
                console.error('Embedding error:', error);
                return [];
            }
        }

        function cosineSimilarity(vecA, vecB) {
            if (!vecA.length || !vecB.length) return 0;
            const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
            const normA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const normB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            return normA * normB ? dotProduct / (normA * normB) : 0;
        }

        async function retrieveDocuments(query) {
            const queryEmbedding = await getEmbedding(query);
            return documents
                .map(doc => ({ ...doc, score: cosineSimilarity(queryEmbedding, doc.embedding) }))
                .filter(doc => doc.score > 0.5)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${messageText}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(userMessage);

            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'thinking-indicator';
            thinkingIndicator.innerHTML = `
                <div class="thinking-spinner">
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot"></span>
                </div>
            `;
            chatMessages.appendChild(thinkingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const relevantDocs = await retrieveDocuments(messageText);

                const messages = [
                    {
                        role: 'system',
                        content: `You are HELPER GPT, a personal tutor and assistance provider powered by Meta Llama 3.2 11B Vision Instruct. Provide clear, concise, and accurate responses tailored for students. Solve math and science problems with step-by-step explanations. Analyze images and documents to answer related questions. Summarize topics clearly and explain complex concepts in detail. Assist with homework, assignments, projects, and coding tasks. Avoid emojis, markdown, and unnecessary symbols. Use context from uploaded materials if available, otherwise rely on general knowledge.`
                    },
                    {
                        role: 'user',
                        content: messageText + (relevantDocs.length > 0 ? `\n\nContext from uploaded materials:\n${relevantDocs.map(doc => doc.content).join('\n\n')}` : '')
                    }
                ];

                relevantDocs.forEach(doc => {
                    if (doc.base64) {
                        messages.push({
                            role: 'user',
                            content: [
                                { type: 'text', text: 'This is an image from the study materials.' },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${doc.base64}` } }
                            ]
                        });
                    }
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://helper-srm.com',
                        'X-Title': 'HELPER GPT'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages,
                        max_tokens: 500,
                        temperature: 0.6,
                        top_p: 0.95
                    })
                });

                const data = await response.json();
                const reply = data.choices?.[0]?.message?.content || 'No response generated.';

                thinkingIndicator.remove();

                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${reply}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatMessages.appendChild(botMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Generation error:', error);
                thinkingIndicator.remove();
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">Sorry, an error occurred while generating the response. Please try again.</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatMessages.appendChild(botMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            chatInput.value = '';
        }

        async function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function insertSuggestion(text) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = text;
            chatInput.focus();
        }
    </script>
</body>
</html>